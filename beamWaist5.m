%
%Beam waist 5.3
%
close all;
clear all;

x=[
10.35
10.3
10.25
10.24
10.23
10.22
10.21
10.2
10.19
10.18
10.17
10.15
10.14
10.13
10.12
10.11
10.1
10.09
10.08
10.07
10.06
10.04
10.03
10.02
10.01
10
9.99
9.98
9.96
9.94
9.92
9.9
9.88
9.85
];

xError = [
    0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
0.02886751346
];

p=[
799
795
786
781
777
774
768
760
748
738
724
694
671
651
497
467
439
403
375
344
310
257
223
193
166
146
122
101
73
61
46
31
20
13
];

pError=[
25.99
17.95
19.86
9.81
21.77
15.74
23.68
7.6
23.48
23.38
15.24
14.94
8.71
8.51
18.97
18.67
22.39
10.03
13.75
11.44
3.1
16.57
8.23
7.93
13.66
13.46
5.22
3.01
6.73
2.61
12.46
2.31
0.2
6.13
 ];

errorbar(x,p,pError,'.');
grid on;
title("x (mm) vs p (uW)");
xlabel("x(mm)");
ylabel("power (uW)");


%
%seems tough to fit. will fit derivative
%

deriv =[];
deriverror=[];
x2=[];

for i=2:length(x)
    a=(p(i)-p(i-1))/(x(i)-x(i-1));
    if (a < 5000)
        deriv(i)=(p(i)-p(i-1))/(x(i)-x(i-1));
        deriverror(i)=sqrt(pError(i)^2 +xError(i)^2);
        x2(i)=x(i);
    end
end
figure;

%finding the line that will intersect with the 1/e value of the derivative
y=[];
for i=1:length(deriv)
    y(i) = (1/2.7)*max(deriv);
end

%plot(deriv);
errorbar(x2,deriv,deriverror,'.'); hold on;
plot(x2, y);
xlim([9.8, 10.37]);
grid on;
title("x (mm) vs delta P (uW)");
xlabel("x(mm)");
ylabel("power difference (uW)");

%now use cftool to fit this curve